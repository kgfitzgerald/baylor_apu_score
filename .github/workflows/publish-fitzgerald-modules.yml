
name: Publish Fitzgerald Modules only

on:
  push:
    branches: [main]
    # ✅ Only run when my module files change
    paths:
      - 'volleyball/ncaa_d1/**'
      - 'baseball/mlb_prime_age/**'
      - '.github/workflows/publish-fitzgerald-modules.yml'
  workflow_dispatch:  # ✅ lets you run manually from the Actions tab

# ✅ Cancel previous runs for the same branch if you push again quickly
concurrency:
  group: publish-fitzgerald-${{ github.ref }}
  cancel-in-progress: true

jobs:
  render-and-publish:
    runs-on: ubuntu-latest

    # Needed to push to gh-pages
    permissions:
      contents: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.4'

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      # ✅ Cache R package downloads and compiled packages to speed up subsequent runs
      - name: Cache R packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/R
            ~/R/x86_64-pc-linux-gnu-library/4.4
          key: ${{ runner.os }}-r-4.4-pkgs-${{ hashFiles('volleyball/ncaa_d1/**', 'baseball/mlb_prime_age/**') }}
          restore-keys: |
            ${{ runner.os }}-r-4.4-pkgs-

      # ───────── Volleyball ─────────
      - name: Install volleyball packages (no repo scan)
        run: |
          Rscript -e 'install.packages(c("tidyverse","ggridges","cowplot"), repos="https://cloud.r-project.org")'

      - name: Render volleyball index.qmd explicitly
        run: quarto render volleyball/ncaa_d1/index.qmd

      # ───────── MLB Prime Age ─────────
      - name: Install MLB packages (no repo scan)
        run: |
          Rscript -e 'install.packages(c("tidyverse","knitr","shiny"), repos="https://cloud.r-project.org")'
        # If MLB uses more packages, add them to the vector above.

      - name: Render MLB index.qmd explicitly
        run: quarto render baseball/mlb_prime_age/index.qmd

      # ───────── Publish without re-rendering ─────────
      - name: Publish to GitHub Pages (no re-render)
        uses: quarto-dev/quarto-actions/publish@v2
        with:
          target: gh-pages
          path: .
          render: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
