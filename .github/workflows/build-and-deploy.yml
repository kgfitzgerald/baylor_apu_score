name: Render and Deploy Website

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  render-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      # 1 ▸ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2 ▸ Setup R
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: "4.4"

      # 3 ▸ Install Linux system dependencies (fixes pak/curl + common R builds)
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev

      # 4 ▸ Install & cache R packages
      - name: Install R dependencies (cached)
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages: |
            tidyverse
            knitr
            kableExtra
            plotly
            flextable
            NbClust
            ClusterR
            parameters
            mclust
            easystats
            condformat
            formattable
            reactablefmtr
            scales
            here
            formatR
            cluster
            cowplot
            DescTools
            effectsize
            fmsb
            fpp3
            ggplot2
            ggridges
            gt
            gtExtras
            infer
            irr
            janitor
            lubridate
            magrittr
            patchwork
            psych
            pwr
            readr
            rmarkdown
            shiny
            showtext
            SimplyAgree
            survival
            survminer
            webexercises
            DT
            learnr
          cache: true

      # 5 ▸ Setup Quarto
      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      # 6 ▸ Render site
      - name: Render site
        run: quarto render

      # 7 ▸ Commit and push rendered docs
      - name: Commit and push docs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update site via GitHub Actions [skip ci]"
          git pull --rebase
          git push
        shell: bash

